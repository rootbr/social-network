# Домашнее задание - Нагрузочное тестирование и оптимизация индексов

## Описание задачи

**Цель:** Провести нагрузочное тестирование поиска пользователей, подобрать оптимальные индексы и проанализировать производительность.

**Навыки:**
- Генерация тестовых данных
- Работа с индексами PostgreSQL
- Нагрузочное тестирование
- Анализ производительности

## Техническое задание

1. **Генерация данных:** Создать 1,000,000 анкет с реальными именами и фамилиями
2. **Реализация поиска:** Метод `/user/search` с поиском по префиксу имени и фамилии (`firstName LIKE ? AND lastName LIKE ?`)
3. **Нагрузочное тестирование:** Тесты с 1/10/100/1000 одновременных запросов
4. **Оптимизация:** Создание подходящих индексов
5. **Сравнительный анализ:** Графики производительности до и после индексации

## План выполнения

- [x] 1. Анализ текущей схемы БД и структуры таблицы users
- [x] 2. Генерация 1,000,000 тестовых записей пользователей
- [x] 3. Реализация/проверка метода `/user/search` 
- [x] 4. Создание JMeter тест-плана для нагрузочного тестирования
- [ ] 5. Проведение базового нагрузочного тестирования (без индексов)
- [ ] 6. Анализ explain plan запросов поиска
- [ ] 7. Создание оптимальных индексов
- [ ] 8. Повторное нагрузочное тестирование (с индексами)
- [ ] 9. Построение графиков latency и throughput
- [ ] 10. Подготовка итогового отчета

## Импорт тестовых данных

### Подготовка

**Ubuntu/Debian:**
```bash
# Установка Python3 и pip (если не установлены)
sudo apt update
sudo apt install python3 python3-pip python3-venv

# Создание виртуального окружения
python3 -m venv venv
source venv/bin/activate

# Установка зависимостей Python
pip install -r requirements.txt
```

**macOS:**
```bash
# Установка Python3 и pip через Homebrew (если не установлены)
brew install python3

# Создание виртуального окружения
python3 -m venv venv
source venv/bin/activate

# Установка зависимостей Python
pip install -r requirements.txt
```

**Общие команды для запуска БД и миграций:**
```bash
# Запуск PostgreSQL (если используется Docker)
docker-compose up -d

# Применение миграций БД
mvn liquibase:update
```

### Импорт данных
```bash
# Запуск скрипта импорта
python3 import_test_data.py
```

### Тестирование endpoint'а поиска пользователей

**Запуск приложения:**
```bash
# Собрать и запустить приложение
mvn clean package
java -jar target/social-network-1.0.0.jar

# Или через Docker
docker-compose up
```

**Тестовые запросы curl:**
```bash
curl -G -X GET "http://localhost:8080/user/search" -H "Accept: application/json" \
  --data-urlencode "first_name=А" \
  --data-urlencode "last_name=А"
```

**Ожидаемый формат ответа:**
```json
[
  {
    "id": "uuid-here",
    "first_name": "Александр",
    "second_name": "Абрамов",
    "birthdate": "1990-01-01", 
    "biography": "Увлекаюсь программированием",
    "city": "Москва"
  }
]
```

**Примечания:**
- Endpoint: `GET /user/search`
- Параметры: `first_name` и `last_name` (оба обязательные)
- Поиск: по префиксу (LIKE 'value%')
- Авторизация: не требуется
- Сортировка: результаты сортируются по ID пользователя

### Описание файлов
- `people.v2.csv` - CSV файл с тестовыми данными (~1М записей, UTF-8)
  - Формат: `Фамилия Имя,YYYY-MM-DD,Город`
  - Размер: ~56MB, 999,930 строк
  - **Примечание**: Файл может иметь неполный UTF-8 символ в конце (обрабатывается автоматически)
- `import_test_data.py` - Python скрипт для импорта данных в PostgreSQL
- `requirements.txt` - Python зависимости (psycopg2, bcrypt)

### Возможные проблемы и решения

**Ошибка кодировки UTF-8:**
```
Error: 'utf-8' codec can't decode byte 0xd0 in position 0: unexpected end of data
```
Решение: скрипт уже настроен на игнорирование поврежденных символов с параметром `errors='ignore'`

## Нагрузочное тестирование

### JMeter тест-план
Создан файл `user-search-load-test.jmx` с тестами для разных уровней нагрузки:
- **1 пользователь** - базовый тест (100 запросов)
- **10 пользователей** - нагрузочное тестирование (10×100 запросов)
- **100 пользователей** - высокая нагрузка (100×100 запросов)
- **1000 пользователей** - стресс-тестирование (1000×100 запросов)

### Запуск тестов
```bash
# Установка JMeter (если не установлен)
sudo apt install jmeter  # Ubuntu/Debian
brew install jmeter      # macOS

# Запуск всех тестов
./run-load-tests.sh

# Запуск отдельного теста
./run-load-tests.sh 1     # только 1 пользователь
./run-load-tests.sh 10    # только 10 пользователей
./run-load-tests.sh 100   # только 100 пользователей
./run-load-tests.sh 1000  # только 1000 пользователей
```

### Результаты тестирования
- JTL файлы с метриками: `results/`
- HTML отчеты: `results/[test_name]_[timestamp]_html/`
- Автоматический анализ базовых метрик в консоли

## Ожидаемые результаты

### Отчет должен содержать:
- Графики latency до и после индексации
- Графики throughput до и после индексации  
- SQL запрос создания индекса
- EXPLAIN результаты запросов с индексом
- Обоснование выбора типа и структуры индекса
- Выводы о влиянии индексации на производительность

## Текущий прогресс

### Выполнено
- Изучение OpenAPI спецификации
- Создание плана выполнения ДЗ

### В процессе
- Анализ текущей реализации

### Заметки
- Метод `/user/search` уже описан в openapi.json (строки 167-218)
- Поиск должен быть по `first_name` и `last_name` одновременно
- Требуется сортировка по ID пользователя
- Проект использует PostgreSQL с raw JDBC